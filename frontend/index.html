<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#b80000" />
    <title>Klassisches Reaktionsspiel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />

    <style>
      /* Startscreen-Stil */
      #startscreen {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #b80000;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 5vw;
        z-index: 9999;
      }

      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgb(184, 0, 0);
        font-family: sans-serif;
        cursor: pointer;
        transition: background-color 0.5s;
        text-align: center;
        padding: 1rem;
        color: white;
      }

      h1 {
        font-size: 1.6rem;
        margin: 0.5rem 0;
      }

      p {
        font-size: 1.2rem;
      }

      #restartButton {
        display: none;
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        background-color: white;
        color: black;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      #restartButton:hover {
        background-color: #eee;
      }

      #message.animate {
        animation: pulse 0.6s ease;
      }

      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.4); }
        100% { transform: scale(1); }
      }

      #highscore {
        font-size: 16px;
        color: #ddd;
        margin-top: 10px;
      }

      /* Dunkelmodus */
      @media (prefers-color-scheme: dark) {
        #startscreen {
          background-color: #550000;
        }
        body {
          background-color: #330000;
          color: #ddd;
        }
        h1, p, #highscore {
          color: #eee;
        }
        #restartButton {
          background-color: #555;
          color: white;
        }
        #restartButton:hover {
          background-color: #777;
        }
        #message {
          color: #eee;
        }
      }
    </style>
  </head>
  <body id="background">
    <div id="startscreen">Lade Reaktionsspiel...</div>

    <h1 class="headline">Klicke sobald der Bildschirm seine Farbe √§ndert!</h1>
    <p id="message">Bereit?</p>
    <p id="highscore"></p>
    <button id="restartButton" onclick="location.reload()">Neu starten</button>

    <!-- Beep-Ton -->
    <audio id="beepSound" src="beep.mp3" preload="auto"></audio>

    <script>
      let startTime;
      let isGreen = false;
      let clicked = false;
      let timeoutID;

      const background = document.getElementById("background");
      const message = document.getElementById("message");
      const restartButton = document.getElementById("restartButton");
      const highscoreDisplay = document.getElementById("highscore");
      const beepSound = document.getElementById("beepSound");
      const startScreen = document.getElementById("startscreen");

      let bestTime = localStorage.getItem("highscore");
      if (bestTime !== null) {
        let bestTimeSeconds = (parseFloat(bestTime) / 1000).toFixed(3);
        highscoreDisplay.innerText = `Bester Versuch: ${bestTimeSeconds} Sekunden`;
      }

      function changeBackground() {
        let min = 3;
        let max = 6;
        let rndmTime = Math.floor(Math.random() * (max - min + 1) + min);
        let delay = rndmTime * 1000;

        timeoutID = setTimeout(() => {
          if (!clicked) {
            background.style.backgroundColor = "green";
            beepSound.play();
            startTime = Date.now();
            isGreen = true;
            message.innerText = "JETZT klicken!";
          }
        }, delay);
      }

      function measureTime() {
        if (clicked) return;
        clicked = true;

        if (!isGreen) {
          message.innerText = "Zu fr√ºh! Neu starten, um es erneut zu versuchen.";
          background.style.backgroundColor = "gray";
          clearTimeout(timeoutID);
          restartButton.style.display = "inline-block";
          return;
        }

        let reactionTime = Date.now() - startTime;
        let reactionInSeconds = (reactionTime / 1000).toFixed(3);
        message.innerText = `Reaktionszeit: ${reactionInSeconds} Sekunden`;
        message.classList.add("animate");

        if (bestTime === null || reactionTime < bestTime) {
          localStorage.setItem("highscore", reactionTime);
          highscoreDisplay.innerText = `üèÜ Neuer Highscore: ${reactionInSeconds} Sekunden!`;
        }

        restartButton.style.display = "inline-block";
      }

      window.onload = () => {
        changeBackground();
        document.addEventListener("click", measureTime);

        // Startscreen nach 2 Sekunden ausblenden
        setTimeout(() => {
          startScreen.style.display = "none";
        }, 2000);
      };

      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("service-worker.js")
            .then((registration) => {
              console.log("Service Worker registriert:", registration);
            })
            .catch((error) => {
              console.error("Service Worker Registrierung fehlgeschlagen:", error);
            });
        });
      }

      // Public VAPID Key
      const publicVapidKey = "BOxnFFyTXl1SPNdGicE-mr66IbGzWhylvOHA-xuxP4VaKdC-f12SS_N25YqUtfKY2N_nxxCyYUtdhRvNdfIwwls";

      if ("serviceWorker" in navigator && "PushManager" in window) {
        navigator.serviceWorker.ready
          .then((registration) => {
            return registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array(publicVapidKey),
            });
          })
          .then((subscription) => {
            console.log("Subscription:", subscription);

            // Subscription an den Server senden:
            fetch("https://reaktionsspiel-server.onrender.com/subscribe", {
              method: "POST",
              body: JSON.stringify(subscription),
              headers: {
                "Content-Type": "application/json",
              },
            });
          });
      }

      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding)
          .replace(/-/g, "+")
          .replace(/_/g, "/");
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      if ("Notification" in window && navigator.serviceWorker) {
        Notification.requestPermission().then((permission) => {
          if (permission === "granted") {
            console.log("Benachrichtigungen erlaubt");
          } else {
            console.log("Benachrichtigungen blockiert");
          }
        });
      }
    </script>
  </body>
</html>
