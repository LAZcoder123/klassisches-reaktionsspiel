<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#b80000" />
    <title>Klassisches Reaktionsspiel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />

    <style>
      /* Basis Styles */
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: sans-serif;
        cursor: pointer;
        text-align: center;
        transition: background-color 0.5s, color 0.5s;
      }

      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgb(184, 0, 0);
        color: white;
        padding: 1rem;
      }

      h1.headline {
        font-size: 1.6rem;
        margin: 0.5rem 0;
      }

      p {
        font-size: 1.2rem;
      }

      #restartButton {
        display: none;
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        background-color: white;
        color: black;
        cursor: pointer;
      }

      #restartButton:hover {
        background-color: #eee;
      }

      #message.animate {
        animation: pulse 0.6s ease;
      }

      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.4); }
        100% { transform: scale(1); }
      }

      #highscore {
        font-size: 16px;
        color: #ddd;
        margin-top: 10px;
      }

      /* Startscreen */
      #startScreen {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #b80000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 1.5rem;
        z-index: 1000;
        cursor: pointer;
      }

      /* Dark Mode */
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #440000;
          color: #eee;
        }
        #restartButton {
          background-color: #333;
          color: #eee;
        }
        #restartButton:hover {
          background-color: #555;
        }
        #highscore {
          color: #aaa;
        }
        #startScreen {
          background-color: #440000;
        }
      }
    </style>
  </head>
  <body id="background">
    <div id="startScreen">Tippe zum Starten!</div>

    <h1 class="headline">Klicke sobald der Bildschirm seine Farbe √§ndert!</h1>
    <p id="message"></p>
    <p id="highscore"></p>
    <button id="restartButton" onclick="location.reload()">Neu starten</button>

    <!-- Beep-Ton -->
    <audio id="beepSound" src="beep.mp3" preload="auto"></audio>

    <script>
      let startTime;
      let isGreen = false;
      let clicked = false;
      let timeoutID;

      const background = document.getElementById("background");
      const message = document.getElementById("message");
      const restartButton = document.getElementById("restartButton");
      const highscoreDisplay = document.getElementById("highscore");
      const beepSound = document.getElementById("beepSound");
      const startScreen = document.getElementById("startScreen");

      let bestTime = localStorage.getItem("highscore");
      if (bestTime !== null) {
        let bestTimeSeconds = (parseFloat(bestTime) / 1000).toFixed(3);
        highscoreDisplay.innerText = `Bester Versuch: ${bestTimeSeconds} Sekunden`;
      }

      function changeBackground() {
        let min = 3;
        let max = 6;
        let rndmTime = Math.floor(Math.random() * (max - min + 1) + min);
        let delay = rndmTime * 1000;

        timeoutID = setTimeout(() => {
          if (!clicked) {
            background.style.backgroundColor = "green";
            beepSound.play();
            startTime = Date.now();
            isGreen = true;
            message.innerText = "JETZT klicken!";
          }
        }, delay);
      }

      function measureTime() {
        if (clicked) return;
        clicked = true;

        if (!isGreen) {
          message.innerText = "Zu fr√ºh! Neu starten, um es erneut zu versuchen.";
          background.style.backgroundColor = "gray";
          clearTimeout(timeoutID);
          restartButton.style.display = "inline-block";
          return;
        }

        let reactionTime = Date.now() - startTime;
        let reactionInSeconds = (reactionTime / 1000).toFixed(3);
        message.innerText = `Reaktionszeit: ${reactionInSeconds} Sekunden`;
        message.classList.add("animate");

        if (bestTime === null || reactionTime < bestTime) {
          localStorage.setItem("highscore", reactionTime);
          highscoreDisplay.innerText = `üèÜ Neuer Highscore: ${reactionInSeconds} Sekunden!`;
        }

        restartButton.style.display = "inline-block";
      }

      // Startscreen Klick startet das Spiel
      startScreen.addEventListener("click", () => {
        startScreen.style.display = "none";
        message.innerText = "Bereit?";
        changeBackground();
        document.addEventListener("click", measureTime);
      });

      // Service Worker Registrierung und Update-Handling
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("service-worker.js").then(registration => {
            console.log("Service Worker registriert:", registration);

            registration.onupdatefound = () => {
              const newWorker = registration.installing;
              newWorker.onstatechange = () => {
                if (newWorker.state === "installed") {
                  if (navigator.serviceWorker.controller) {
                    console.log("Neue Version verf√ºgbar, Seite wird neu geladen");
                    window.location.reload();
                  }
                }
              };
            };
          }).catch(error => {
            console.error("Service Worker Registrierung fehlgeschlagen:", error);
          });
        });
      }

      // Push Notifications Subscription (dein Public Vapid Key)
      const publicVapidKey = "BOxnFFyTXl1SPNdGicE-mr66IbGzWhylvOHA-xuxP4VaKdC-f12SS_N25YqUtfKY2N_nxxCyYUtdhRvNdfIwwls";

      if ("serviceWorker" in navigator && "PushManager" in window) {
        navigator.serviceWorker.ready
          .then(registration => registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
          }))
          .then(subscription => {
            console.log("Subscription:", subscription);

            fetch("https://reaktionsspiel-server.onrender.com/subscribe", {
              method: "POST",
              body: JSON.stringify(subscription),
              headers: {
                "Content-Type": "application/json",
              },
            });
          });
      }

      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      if ("Notification" in window && navigator.serviceWorker) {
        Notification.requestPermission().then(permission => {
          if (permission === "granted") {
            console.log("Benachrichtigungen erlaubt");
          } else {
            console.log("Benachrichtigungen blockiert");
          }
        });
      }
    </script>
  </body>
</html>
